<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="home.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
    <script src="user.js"></script>
</head>
<body>
<div class="container">
    <div class="profile-page tx-13">
        <div class="row">
            <div class="col-12 grid-margin">
                <div class="profile-header">
                    <div class="cover">
                        <div class="gray-shade"></div>
                        <figure>
                            <img src="https://i.pinimg.com/originals/21/32/e4/2132e409ad724865fe6375cdf463f7c2.jpg"
                                 class="img-fluid" alt="profile cover">
                        </figure>
                        <div class="cover-body d-flex justify-content-between align-items-center">
                            <div>
                                <div id="avatarUser"></div>
                                <span class="profile-name" id="nameUser" onclick="showUserDetail()"></span>
                                <table id="reloadAvatar">
                                    <tr>
                                        <td>
                                            <input type="file" value="Thay avatar" accept=".jpg" id="fileButtonAv">
                                            <input type="hidden" id="imageAv">
                                        </td>
                                        <td id="closeupload">
                                            <button>Đóng</button>
                                        </td>
                                    </tr>
                                </table>
                            </div>

                        </div>
                    </div>
                    <div class="header-links">
                        <ul class="links d-flex align-items-center mt-3 mt-md-0">
                            <li class="header-link-item d-flex align-items-center active">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round" class="feather feather-columns mr-1 icon-md">
                                    <path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"></path>
                                </svg>
                                <a class="pt-1px d-none d-md-block" href="#" onclick="homepage()"
                                   type="button">Timeline</a>
                            </li>
                            <li class="header-link-item ml-3 pl-3 border-left d-flex align-items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round" class="feather feather-user mr-1 icon-md">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                                <a class="pt-1px d-none d-md-block" href="#">About</a>
                            </li>
                            <li class="header-link-item ml-3 pl-3 border-left d-flex align-items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round" class="feather feather-users mr-1 icon-md">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                <a class="pt-1px d-none d-md-block" href="#">Friends <span class="text-muted tx-12"
                                                                                           id="countfriend"></span></a>
                            </li>
                            <li class="header-link-item ml-3 pl-3 border-left d-flex align-items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round" class="feather feather-image mr-1 icon-md">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                <a class="pt-1px d-none d-md-block" href="#">Photos</a>
                            </li>
                            <li class="header-link-item ml-3 pl-3 border-left d-flex align-items-center">
                                <i class="fas fa-sign-out-alt" style="color: #073489"></i>
                                <a class="pt-1px d-none d-md-block" href="#" onclick="logout()" style="color: #073489">Logout</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row profile-body">
            <!-- left wrapper start -->
            <div class="d-none d-md-block col-md-4 col-xl-3 left-wrapper"
                 style="background-image:url('https://png.pngtree.com/thumb_back/fh260/background/20201208/pngtree-checkered-blue-simple-background-image_505269.jpg'); background-repeat: repeat">
                <div class="card rounded">
                    <div class="card-body">
                        <div id="friend">

                        </div>
                    </div>
                </div>
            </div>
            <!-- left wrapper end -->
            <!-- middle wrapper start -->
            <div class="col-md-8 col-xl-6 middle-wrapper">
                <div class="row">
                    <div class="col-md-12 grid-margin">
                        <div class="card rounded">
                            <div class="card-body">
                                <div id="timeline">
                                    <input type="hidden" id="page" value=0>
                                    <div id="posts">
                                        <div id="uploadfile"></div>
                                        <input type="hidden" id="idPost">
                                        <input id="content" type="text" placeholder="Bạn đang nghĩ gì?"
                                               style="width: 410px">
                                        <select name="" id="privacy">
                                            <option value="public">Public</option>
                                            <option value="friend">Friend</option>
                                            <option value="onlyme">Onlyme</option>
                                        </select><br>
                                        <input type="file" value="upload" accept=".jpg" id="fileButton"><br>
                                        <input type="hidden" id="image"><br>
                                        <button onclick="post()" type="button" class="btn btn-outline-success"
                                                style="width: 500px">Đăng bài
                                        </button>
                                        <hr>
                                    </div>
                                    <div id="listpost"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- middle wrapper end -->
            <!-- right wrapper start -->
            <div class="d-none d-xl-block col-xl-3 right-wrapper"
                 style="background-image:url('https://png.pngtree.com/thumb_back/fh260/background/20201208/pngtree-checkered-blue-simple-background-image_505269.jpg'); background-repeat: repeat ">
                <div class="row">
                    <div class="col-md-12 grid-margin">
                        <div class="card rounded">
                            <div class="card-body">
                                <table>
                                    <tr>
                                        <td>
                                            <input type="text" placeholder="Nhập email của bạn bè" id="email">
                                        </td>
                                        <td>
                                            <button onclick="searchFriend()"><i class="fas fa-search"></i></button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div id="refriend"></div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="card-body">
                                <div id="alert">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- right wrapper end -->
        </div>
    </div>
</div>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAW8VF35-_YFnNNBMT9RAjzCHj-SUqR8Uw",
        authDomain: "filebase-70567.firebaseapp.com",
        projectId: "filebase-70567",
        storageBucket: "filebase-70567.appspot.com",
        messagingSenderId: "370746607348",
        appId: "1:370746607348:web:b17a663c94df4db78c00a1",
        measurementId: "G-8VZX3F9WF8"
    };
    firebase.initializeApp(firebaseConfig);

    //up anh bai post
    let fbBucketName = 'images';
    let fileButton = document.getElementById('fileButton');
    fileButton.addEventListener('change', function (e) {
        let file = e.target.files[0];
        let storageRef = firebase.storage().ref(`${fbBucketName}/${file.name}`);
        let uploadTask = storageRef.put(file);
        uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED,
            function (snapshot) {
                switch (snapshot.state) {
                    case firebase.storage.TaskState.PAUSED: // or 'paused'
                        break;
                    case firebase.storage.TaskState.RUNNING: // or 'running'
                        break;
                }
            },
            function (error) {
                switch (error.code) {
                    case 'storage/unauthorized':
                        break;
                    case 'storage/canceled':
                        break;
                    case 'storage/unknown':
                        break;
                }
            }, function () {
                let downloadURL = uploadTask.snapshot.downloadURL;

                document.getElementById("uploadfile").innerHTML = '<img width="100px" height="auto" src=' + downloadURL + '/>';
                document.getElementById("image").value = downloadURL;
            });
    });

    //up avatar
    let fbBucketNameAv = 'imagesAv';
    let fileButtonAv = document.getElementById('fileButtonAv');
    fileButtonAv.addEventListener('change', function (e) {
        let file = e.target.files[0];
        let storageRef = firebase.storage().ref(`${fbBucketNameAv}/${file.name}`);
        let uploadTask = storageRef.put(file);
        uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED,
            function (snapshot) {
                switch (snapshot.state) {
                    case firebase.storage.TaskState.PAUSED: // or 'paused'
                        break;
                    case firebase.storage.TaskState.RUNNING: // or 'running'
                        break;
                }
            },
            function (error) {
                switch (error.code) {
                    case 'storage/unauthorized':
                        break;
                    case 'storage/canceled':
                        break;
                    case 'storage/unknown':
                        break;
                }
            }, function () {
                let path = uploadTask.snapshot.downloadURL;
                let newAvatar = {path: path}
                let idAcc = window.sessionStorage.getItem('ID_KEY');
                $.ajax({
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': window.sessionStorage.getItem('TOKEN_KEY')
                    },
                    type: "PUT",
                    data: JSON.stringify(newAvatar),
                    //tên API
                    url: "https://vilo-vn.herokuapp.com/user/reloadAvatar/" + idAcc,
                    //xử lý khi thành công
                    success: function () {
                        showUser();
                    },
                    error: function () {
                        window.sessionStorage.removeItem('AVATAR_KEY');
                        window.sessionStorage.setItem('AVATAR_KEY', path);
                        showUser();
                        window.location.reload();
                    }
                })
            });
    });
</script>
</body>
</html>